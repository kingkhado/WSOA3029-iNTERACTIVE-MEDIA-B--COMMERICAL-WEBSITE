<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>South Africa Choropleth Map</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .tooltip { 
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .loading { 
            position: absolute;
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 20px; 
        }
        .dropdown { 
            margin: 10px;
            padding: 5px;
            font-size: 16px;
        }
        #chart { width: 100%; height: 600px; }
    </style>
</head>
<body>

    <div id="chart"></div>
    <div class="loading" id="loading-message">Loading Data...</div>

    <select id="filter" class="dropdown">
        <option value="population">Population</option>
        <option value="homelessness">Homelessness Rate</option>
    </select>

    <input type="text" id="search" placeholder="Search for a Province" class="dropdown">

    <div class="tooltip" id="tooltip"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Set up the SVG container
        const width = 960, height = 600;
        const projection = d3.geoMercator().center([24, -30]).scale(700);
        const path = d3.geoPath().projection(projection);
        const svg = d3.select("#chart").append("svg").attr("width", width).attr("height", height);

        // Load geoJSON and API data
        Promise.all([
            d3.json("path_to_south_africa_geojson_file.json"),
            d3.json("https://apps.itos.uga.edu/CODV2API/api/v1/themes/cod-ps/lookup/Get/1/do/ZAF")
        ]).then(([geoData, apiData]) => {
            document.getElementById("loading-message").style.display = "none"; // Hide loading message

            // Prepare data by matching provinces
            geoData.features.forEach((feature) => {
                const province = apiData.find(p => p.province_name === feature.properties.name);
                if (province) {
                    feature.properties.data = province.data; // Add the data to each province
                }
            });

            // Draw the map with provinces color-coded based on population or homelessness
            const colorScale = d3.scaleQuantize().domain([0, 100]).range(d3.schemeBlues[9]);

            svg.selectAll("path")
                .data(geoData.features)
                .enter().append("path")
                .attr("d", path)
                .attr("fill", d => colorScale(d.properties.data.population || 0)) // Use population data as default
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("stroke", "black").attr("stroke-width", 2);
                    d3.select("#tooltip").style("display", "block")
                        .html(`Province: ${d.properties.name}<br>Population: ${d.properties.data.population}`)
                        .style("left", `${event.pageX + 5}px`)
                        .style("top", `${event.pageY - 28}px`);
                })
                .on("mouseout", function() {
                    d3.select(this).attr("stroke", "none");
                    d3.select("#tooltip").style("display", "none");
                })
                .on("click", function(event, d) {
                    alert(`Province: ${d.properties.name}\nPopulation: ${d.properties.data.population}\nHomelessness Rate: ${d.properties.data.homelessness_rate}`);
                });

            // Set up filter and search functionality
            d3.select("#filter").on("change", function() {
                const filterValue = this.value;
                svg.selectAll("path")
                    .transition()
                    .duration(500)
                    .attr("fill", d => {
                        const metric = d.properties.data[filterValue] || 0;
                        return colorScale(metric);
                    });
            });

            d3.select("#search").on("input", function() {
                const searchTerm = this.value.toLowerCase();
                svg.selectAll("path")
                    .style("opacity", d => {
                        return d.properties.name.toLowerCase().includes(searchTerm) ? 1 : 0.2;
                    });
            });
        });
    </script>
</body>
</html>
